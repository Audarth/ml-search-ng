angular.module("ml.search",["ml.common"]),function(){"use strict";function e(e,n){function r(r,a){var s;return _.isObject(r)&&!a&&(a=r,r=null),s=new t(e,n,a),r&&(u[r]=s),s}function a(e){return u[e]}var u={};return{newContext:r,getNamedContext:a}}function t(e,t,n){function r(){return T}function a(){return D}function u(e){return D=""!==e?e:null,this}function s(){var e=Math.floor(E/n.pageLength)+1;return e}function c(e){return E=1+(e-1)*n.pageLength,this}function o(){return n.pageLength}function i(e){return n.pageLength=e,this}function l(){return B}function f(e){return B=e,this}function p(){return B=null,this}function h(){return n.snippet}function m(e){return n.snippet=e,this}function g(){return n.snippet="compact",this}function y(){return n.queryOptions}function q(e,t,n){return $[e]&&!_.contains($[e].values,t)?$[e].values.push(t):$[e]={type:n,values:[t]},this}function d(e,t){return $[e].values=_.filter($[e].values,function(e){return e!==t}),this}function v(){return $={},_.forIn(T.facets,function(e){e.selected&&_.chain(e.facetValues).where({selected:!0}).each(function(t){e.selected=t.selected=!1})}),this}function L(e,t){var n=!1;return e&&(_.chain(e.facetValues).where({name:t}).each(function(e){n=e.selected=!e.selected}),e.selected=_.where(e.facetValues,{selected:!0}).length>0),n}function S(e,t){var n=T.facets[e];return L(n,t)?q(e,t,n.type):d(e,t),this}function x(e){_.forIn(e,function(e,t){var n=$[t];n&&_.chain(e.facetValues).filter(function(e){return _.contains(n.values,e.name)}).each(function(t){e.selected=t.selected=!0})})}function w(e){var t=e.metadata;e.metadata={},_.each(t,function(t){var n=_.without(_.keys(t),"metadata-type")[0],r=t["metadata-type"],a=t[n];_.contains(e.metadata,n)||(e.metadata[n]={"metadata-type":r,values:[]}),e.metadata[n].values.push(a)})}function P(){var r=e.defer();return t.search({options:n.queryOptions,structuredQuery:Q(),start:E,pageLength:n.pageLength}).then(function(e){T=e.data,_.each(T.results,w),x(T.facets),r.resolve(T)},function(e){r.reject(e)}),r.promise}function b(e,t,r){return n.multiFacetUnion?_.each(t,function(t){e.push(r([t]))}):e.push(r(t)),e}function k(e,t,n){var r,a={};return function(u,s){var c=u+"-constraint-query";return a[c]={"constraint-name":e},s=s||"value",r=function(e){return a[c][s]=e,a},b(n,t,r)}}function F(){var e=[];return _.forIn($,function(t,r){if(t.values.length>0){var a=k(r,t.values,e);"collection"===t.type?a("collection","uri"):a("custom"===t.type||_.contains(n.customConstraintNames,name)?"custom":"range")}}),e}function I(e){var t={};return t=z.length>0?{query:{queries:[{"boost-query":{"matching-query":{"and-query":{queries:e}},"boosting-query":{"and-query":{queries:z}}}}]}}:{query:{queries:[{"and-query":{queries:e}}]}},n.includeProperties&&(t={query:{queries:[{"or-query":{queries:[t,{"properties-query":t}]}}]}}),t}function Q(){var e=F(),t={};return null!==D&&e.push({qtext:D}),t=I(e),B&&t.query.queries.push({"operator-state":{"operator-name":"sort","state-name":B}}),n.snippet&&t.query.queries.push({"operator-state":{"operator-name":"results","state-name":n.snippet}}),t}function C(e){var t,n,r;e["collection-constraint-query"]?(t=e["collection-constraint-query"],r="collection"):e["custom-constraint-query"]?(t=e["custom-constraint-query"],r="custom"):t=e["range-constraint-query"],t&&(n=t.value||t.uri,_.isArray(n)||(n=[n]),_.each(n,function(e){q(t["constraint-name"],e,r)}))}function O(e){e=e["and-query"]||e["or-query"]||e,e.queries?_.each(e.queries,function(e){O(e)}):C(e)}function V(){return n.params}function j(){var e=F(),t=[];return _.each(e,function(e){var r=e[_.keys(e)[0]],a=r["constraint-name"];_.each(r.value||r.uri,function(e){/\s+/.test(e)&&(e='"'+e+'"'),t.push(a+n.params.separator+e)})}),t}function A(){var e=j(),t=s(),r={};return e.length&&(r[n.params.facets]=e),t>1&&(r[n.params.page]=t),D&&(r[n.params.qtext]=D),B&&(r[n.params.sort]=B),r}function M(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function R(e){_.isArray(e)||(e=[e]),_.chain(e).map(M).each(function(e){var t=e.split(n.params.separator);q(t[0],t[1])})}function U(e){_.forIn(e,function(e,t){switch(t){case n.params.qtext:u(M(e));break;case n.params.page:c(parseInt(M(e)));break;case n.params.sort:f(M(e));break;case n.params.facets:R(e);break;default:console.error("unknown param: "+t)}})}var N={},T={},$={},z=[],D=null,B=null,E=1;return n=_.merge(_.cloneDeep(this.defaults),n),N={search:P,getResults:r,getText:a,setText:u,getPage:s,setPage:c,getPageLength:o,setPageLength:i,getSort:l,setSort:f,clearSort:p,getSnippet:h,setSnippet:m,clearSnippet:g,getQueryOptions:y,toggleFacet:S,selectFacet:q,clearFacet:d,clearAllFacets:v,getQuery:Q,parseStructuredQuery:O,getParams:A,getParamsConfig:V,fromParams:U,getStructuredQuery:Q,serializeStructuredQuery:A}}angular.module("ml.search").factory("MLSearchFactory",e),e.$inject=["$q","MLRest"],angular.extend(t.prototype,{defaults:{queryOptions:"all",pageLength:10,snippet:"compact",multiFacetUnion:!1,params:{separator:":",qtext:"q",facets:"f",sort:"s",page:"p"}}})}();