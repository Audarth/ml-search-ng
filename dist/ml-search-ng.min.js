angular.module("ml.search",["ml.common"]),function(){"use strict";function e(e,n){function r(r,u){var c;return _.isObject(r)&&!u&&(u=r,r=null),c=new t(e,n,u),r&&(a[r]=c),c}function u(e){return a[e]}var a={};return{newContext:r,getNamedContext:u}}function t(e,t,n){function r(){return k}function u(){return N}function a(e){return N=""!==e?e:null,this}function c(){return null}function i(e){return T=1+(e-1)*n.pageLength,this}function s(e){return n.pageLength=e,this}function o(e){return R=e,this}function l(){return R=null,this}function f(e){return n.snippet=e,this}function h(){return n.snippet="compact",this}function p(){return n.queryOptions}function y(e,t,n){return A[e]&&!_.contains(A[e].values,t)?A[e].values.push(t):A[e]={type:n,values:[t]},this}function m(e,t){return A[e].values=_.filter(A[e].values,function(e){return e!==t}),this}function q(){return A={},_.forIn(k.facets,function(e){e.selected&&_.chain(e.facetValues).where({selected:!0}).each(function(t){e.selected=t.selected=!1})}),this}function v(e,t){var n=!1;return e&&(_.chain(e.facetValues).where({name:t}).each(function(e){n=e.selected=!e.selected}),e.selected=_.where(e.facetValues,{selected:!0}).length>0),n}function d(e,t){var n=k.facets[e];return v(n,t)?y(e,t,n.type):m(e,t),this}function g(e){_.forIn(e,function(e,t){var n=A[t];n&&_.chain(e.facetValues).filter(function(e){return _.contains(n.values,e.name)}).each(function(t){e.selected=t.selected=!0})})}function L(e){var t=e.metadata;e.metadata={},_.each(t,function(t){var n=_.without(_.keys(t),"metadata-type")[0],r=t["metadata-type"],u=t[n];_.contains(e.metadata,n)||(e.metadata[n]={"metadata-type":r,values:[]}),e.metadata[n].values.push(u)})}function S(){var r=e.defer();return t.search({options:n.queryOptions,structuredQuery:Q(),start:T,pageLength:n.pageLength}).then(function(e){_.each(e.results,L),g(e.facets),k=e,r.resolve(e)},function(e){r.reject(e)}),r.promise}function F(e,t,r){n.multiFacetUnion?_.each(t,function(t){e.push(r([t]))}):e.push(r(t))}function w(e,t,n){var r,u={};return function(a,c){var i=a+"-constraint-query";return u[i]={"constraint-name":e},c=c||"value",r=function(e){return u[i][c]=e,u},F(n,t,r)}}function x(){var e=[];return _.forIn(A,function(t,r){if(t.values.length>0){var u=w(r,t.values,e);"collection"===t.type?u("collection","uri"):u("custom"===t.type||_.contains(n.customConstraintNames,name)?"custom":"range")}}),e}function O(e){var t={};return t=M.length>0?{query:{queries:[{"boost-query":{"matching-query":{"and-query":{queries:e}},"boosting-query":{"and-query":{queries:M}}}}]}}:{query:{queries:[{"and-query":{queries:e}}]}},n.includeProperties&&(t={query:{queries:[{"or-query":{queries:[t,{"properties-query":t}]}}]}}),t}function Q(){var e=x(),t={};return null!==N&&e.push({qtext:N}),t=O(e),R&&t.query.queries.push({"operator-state":{"operator-name":"sort","state-name":R}}),n.snippet&&t.query.queries.push({"operator-state":{"operator-name":"results","state-name":n.snippet}}),t}function j(){var e=x(),t=[];return _.each(e,function(e){var n=e[_.keys(e)[0]];_.each(n.value||n.uri,function(e){/\s+/.test(e)&&(e='"'+e+'"'),t.push(n["constraint-name"]+":"+e)})}),t.join(" ")}function P(){var e=j(),t={};return e&&(t.facets=e),N&&(t.q=N),R&&(t.sort=R),t}function V(e){var t,n,r;e["collection-constraint-query"]?(t=e["collection-constraint-query"],r="collection"):e["custom-constraint-query"]?(t=e["custom-constraint-query"],r="custom"):t=e["range-constraint-query"],t&&(n=t.value||t.uri,_.isArray(n)||(n=[n]),_.each(n,function(e){y(t["constraint-name"],e,r)}))}function b(e){e=e["and-query"]||e["or-query"]||e,e.queries?_.each(e.queries,function(e){b(e)}):V(e)}var C={queryOptions:"all",pageLength:10,snippet:"compact",multiFacetUnion:!1},I={},k={},A={},M=[],N=null,R=null,T=1;return n=angular.extend(C,n),I={search:S,getResponse:r,getText:u,setText:a,getPage:c,setPage:i,setPageLength:s,setSort:o,clearSort:l,setSnippet:f,clearSnippet:h,getQueryOptions:p,toggleFacet:d,selectFacet:y,clearFacet:m,clearAllFacets:q,getStructuredQuery:Q,serializeStructuredQuery:P,parseStructuredQuery:b}}angular.module("ml.search").factory("MLSearchFactory",e),e.$inject=["$q","MLRest"]}();