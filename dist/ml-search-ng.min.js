!function(){"use strict";function t(){return function(t){var e=[];for(var n in t)t[n].__key=n,e.push(t[n]);return e}}function e(){return function(t,e,n){return e=e||10,n=n||"...",t.length<=e||t.length-n.length<=e?t:String(t).substring(0,e-n.length)+n}}angular.module("ml.search",["ml.common"]).filter("object2Array",t).filter("truncate",e)}(),function(){"use strict";function t(){return{restrict:"A",transclude:!0,scope:{mlDuration:"="},link:e}}function e(t,e,r,s,i){t.$watch("mlDuration",function(e){e&&angular.extend(t,{duration:n(e)})}),i(t,function(t){e.append(t)})}function n(t){var e=["P(","(([0-9]*\\.?[0-9]*)Y)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)W)?","(([0-9]*\\.?[0-9]*)D)?",")?","(T","(([0-9]*\\.?[0-9]*)H)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)S)?",")?"],n=new RegExp(e.join("")),r=t.match(n);return{years:parseFloat(r[3])||null,months:parseFloat(r[5])||null,weeks:parseFloat(r[7])||null,days:parseFloat(r[9])||null,hours:parseFloat(r[12])||null,minutes:parseFloat(r[14])||null,seconds:parseFloat(r[16])||null,toString:function(){return t}}}angular.module("ml.search").directive("mlDuration",t)}(),function(){"use strict";function t(){return{restrict:"E",scope:{facets:"=",toggle:"&"},templateUrl:e}}function e(t,e){var n;return n=e.template?"inline"===e.template?"/templates/ml-facets-inline.html":e.template:"/templates/ml-facets.html"}angular.module("ml.search").directive("mlFacets",t)}(),function(){"use strict";function t(t){return r=t,{restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/ml-metrics.html",scope:{search:"=",showDuration:"=?"},link:e}}function e(t,e,r,s,i){void 0===t.showDuration&&(t.showDuration=!0),t.$watch("search",function(e){angular.extend(t,n(e))}),i(t,function(t){t.length&&e.replaceWith(t)})}function n(t){return{total:t.total,start:t.start,pageLength:t["page-length"],pageEnd:r.Math.min(t.start+t["page-length"]-1,t.total),metrics:t.metrics}}angular.module("ml.search").directive("mlMetrics",t);var r=null;t.$inject=["$window"]}(),function(){"use strict";function t(){return{restrict:"E",scope:{results:"=",link:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?e.template:"/templates/ml-results.html"}function n(t,e,n){n.link||(t.link=function(t){return"/detail?uri="+t.result.uri}),t.$watch("results",function(e){_.each(e,function(e){e.link=t.link({result:e})})})}angular.module("ml.search").directive("mlResults",t)}(),function(){"use strict";function t(t,n,r){var s={};return a=t,u=n,o=r,{newContext:function(t,n){var r;return _.isObject(t)&&!n&&(n=t,t=null),r=new e(n),t&&(s[t]=r),r},getNamedContext:function(t){return s[t]}}}function e(t){this.qb=o,this.results={},this.storedOptions={},this.activeFacets={},this.boostQueries=[],this.searchTransform=null,this.qtext=null,this.start=1,this.options=_.merge(_.cloneDeep(this.defaults),t)}function n(t){return decodeURIComponent(t.replace(/\+/g,"%20"))}function r(t,e){function n(t){var e=document.createElement("a");return e.href=t,e.pathname}return n(t)===n(e)}function s(t,e){var n=_.where(t.options.constraint,{name:e})[0];return n.type=n.collection?"collection":n.custom?"custom":n.range.type,n}function i(){var t;return t=0===arguments.length?[]:1===arguments.length?Array.isArray(arguments[0])?arguments[0]:[arguments[0]]:[].slice.call(arguments)}var a=null,o=null,u=null;angular.module("ml.search").factory("MLSearchFactory",t),t.$inject=["$q","MLRest","MLQueryBuilder"],angular.extend(e.prototype,{defaults:{queryOptions:"all",pageLength:10,snippet:"compact",sort:null,facetMode:"and",includeProperties:!1,params:{separator:":",qtext:"q",facets:"f",sort:"s",page:"p"}},getActiveFacets:function(){return this.activeFacets},getBoostQueries:function(){return this.boostQueries},addBoostQuery:function(t){return this.boostQueries.push(t),this},clearBoostQueries:function(){return this.boostQueries=[],this},getTransform:function(){return this.searchTransform},setTransform:function(t){return this.searchTransform=t,this},getText:function(){return this.qtext},setText:function(t){return this.qtext=""!==t?t:null,this},getPage:function(){var t=Math.floor(this.start/this.options.pageLength)+1;return t},setPage:function(t){return this.start=1+(t-1)*this.options.pageLength,this},getQueryOptions:function(){return this.options.queryOptions},getPageLength:function(){return this.options.pageLength},setPageLength:function(t){return this.options.pageLength=t,this},getSnippet:function(){return this.options.snippet},setSnippet:function(t){return this.options.snippet=t,this},clearSnippet:function(){return this.options.snippet=this.defaults.snippet,this},getSort:function(){return this.options.sort},setSort:function(t){return this.options.sort=t,this},clearSort:function(){return this.options.sort=this.defaults.sort,this},getFacetMode:function(){return this.options.facetMode},setFacetMode:function(t){return this.options.facetMode=t,this},getParamsConfig:function(){return this.options.params},getQuery:function(){var t=o.and();return _.keys(this.activeFacets).length&&(t=this.getFacetQuery()),this.qtext&&(t=o.and(t,o.text(this.qtext))),this.boostQueries.length&&(t=o.boost(t,this.boostQueries)),this.options.includeProperties&&(t=o.or(t,o.properties(t))),t=o.query(t),this.options.sort&&t.query.queries.push(o.operator("sort",this.options.sort)),this.options.snippet&&t.query.queries.push(o.operator("results",this.options.snippet)),t},getFacetQuery:function(){var t,e=this,n=[],r={};return _.forIn(e.activeFacets,function(r,s){r.values.length&&(t=function(t){return o.constraint(r.type)(s,t)},"or"===e.options.facetMode?n.push(t(r.values)):n=n.concat(_.map(r.values,t)))}),r="or"===e.options.facetMode?o.or(r):o.and(n)},getCombinedQuery:function(){var t=a.defer(),e={query:this.getQuery()};return this.getStoredOptions(this.options.queryConfig).then(function(n){e.options=n,t.resolve(e)},function(e){t.reject(e)}),t.promise},isFacetActive:function(t,e){var n=this.activeFacets[t];return n&&_.contains(n.values,e)},selectFacet:function(t,e,n){var r=this.activeFacets[t];return r&&!_.contains(r.values,e)?r.values.push(e):this.activeFacets[t]={type:n,values:[e]},this},clearFacet:function(t,e){var n=this.activeFacets[t];return n.values=_.filter(n.values,function(t){return t!==e}),this},toggleFacet:function(t,e){var n;return this.isFacetActive(t,e)?this.clearFacet(t,e):(n=this.results.facets[t].type,this.selectFacet(t,e,n)),this},clearAllFacets:function(){return this.activeFacets={},this},getParams:function(){var t=this.getPage(),e=[],n={};return e=this.getFacetParams(),e.length&&(n[this.options.params.facets]=e),t>1&&(n[this.options.params.page]=t),this.qtext&&(n[this.options.params.qtext]=this.qtext),this.options.sort&&(n[this.options.params.sort]=this.options.sort),n},getFacetParams:function(){var t=this,e=t.getFacetQuery(),n=[],r=[];return n=(e["or-query"]||e["and-query"]).queries,_.each(n,function(e){var n=e[_.keys(e)[0]],s=n["constraint-name"];_.each(n.value||n.uri,function(e){/\s+/.test(e)&&(e='"'+e+'"'),r.push(s+t.options.params.separator+e)})}),r},fromParams:function(t){var e=this,r=a.defer(),s=t[this.options.params.qtext]||null,i=t[this.options.params.facets],o=t[this.options.params.page],u=t[this.options.params.sort];return e.setText(s),o&&e.setPage(parseInt(n(o))),u&&e.setSort(n(u)),e.clearAllFacets(),i?e.results.facets?(e.fromFacetParam(i),r.resolve()):e.getStoredOptions().then(function(t){e.fromFacetParam(i,t),r.resolve()}):r.resolve(),r.promise},fromFacetParam:function(t,e){var r=this,a=_.map(i(t),n);_.each(a,function(t){var n=t.split(r.options.params.separator),i=n[0],a=n[1],o=null;e?o=s(e,i).type:r.results.facets?o=r.results.facets[i].type:console.error("don't have facets or options for '"+i+"', falling back to un-typed range queries"),r.selectFacet(i,a,o)})},locationChange:function(t,e,n){var s=a.defer(),i=r(t,e),o=_.isEqual(this.getParams(),n),u=i&&!o;return u?this.fromParams(n).then(s.resolve):s.reject(),s.promise},getStoredOptions:function(t){var e=this,n=a.defer();return t=t||e.options.queryOptions,e.storedOptions[t]?n.resolve(e.storedOptions[t]):u.queryConfig(t).then(function(r){e.storedOptions[t]=r.data,n.resolve(e.storedOptions[t])},function(t){n.reject(t)}),n.promise},getAllStoredOptions:function(t){var e=this,n=a.defer(),r={};return a.all(_.map(t,e.getStoredOptions)).then(function(){_.each(t,function(t){r[t]=e.storedOptions[t]}),n.resolve(r)}),n.promise},suggest:function(t){var e=a.defer(),n={search:{query:this.getQuery()}},r={"partial-q":t,format:"json",options:this.options.queryOptions};return u.suggest(r,n).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e.promise},search:function(){var t=this,e=a.defer();return u.search({options:t.options.queryOptions,structuredQuery:t.getQuery(),start:t.start,pageLength:t.options.pageLength}).then(function(n){t.results=n.data,t.transformMetadata(),t.annotateActiveFacets(),e.resolve(t.results)},function(t){e.reject(t)}),e.promise},annotateActiveFacets:function(t){var e=this;t=t||e.results.facets,_.forIn(t,function(t,n){var r=e.activeFacets[n];r&&_.chain(t.facetValues).filter(function(t){return _.contains(r.values,t.name)}).each(function(e){t.selected=e.selected=!0})})},transformMetadata:function(t){var e;return t=t||this.results.results,_.isArray(t)?void _.each(t,this.transformMetadata):(e=t.metadata,t.metadata={},void _.each(e,function(e){var n=_.without(_.keys(e),"metadata-type")[0],r=e["metadata-type"],s=e[n];_.contains(t.metadata,n)||(t.metadata[n]={"metadata-type":r,values:[]}),t.metadata[n].values.push(s)}))},getStructuredQuery:function(){return this.getQuery()},serializeStructuredQuery:function(){return this.getParams()}})}();